<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2026 Calendar Wallpaper Maker</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #f5f0eb;
      color: #333;
      min-height: 100vh;
    }

    /* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
    .header {
      text-align: center;
      padding: 32px 16px 0;
    }
    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #5a4a42;
      letter-spacing: 0.06em;
    }
    .header p {
      font-size: 0.8rem;
      color: #aaa;
      margin-top: 4px;
    }

    /* â”€â”€ æœˆãƒŠãƒ“ â”€â”€ */
    .month-nav {
      display: flex;
      gap: 5px;
      justify-content: center;
      flex-wrap: wrap;
      padding: 20px 12px 0;
    }
    .month-nav button {
      width: 52px;
      padding: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      color: #888;
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .month-nav button:hover { border-color: #bbb; }
    .month-nav button.active {
      background: #5a4a42;
      color: #fff;
      border-color: #5a4a42;
      font-weight: 700;
    }
    .month-nav button .dot {
      position: absolute;
      top: 3px;
      right: 3px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #e8a0bf;
      display: none;
    }
    .month-nav button .dot.visible { display: block; }

    /* â”€â”€ ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ â”€â”€ */
    .main {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    /* â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ â”€â”€ */
    .preview-card {
      background: #fff;
      border-radius: 20px;
      padding: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      margin-bottom: 16px;
    }
    .preview-card h3 {
      font-size: 0.8rem;
      color: #aaa;
      text-align: center;
      margin-bottom: 12px;
      font-weight: 400;
    }
    .canvas-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 9 / 16;
      border-radius: 14px;
      overflow: hidden;
      background: #faf5f2;
    }
    .canvas-wrap canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* â”€â”€ å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¾ãƒ¼ãƒ³ â”€â”€ */
    .upload-zone {
      position: relative;
      border: 2px dashed #ddd;
      border-radius: 14px;
      padding: 28px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fdfbf9;
      margin-bottom: 12px;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: #c8a090;
      background: #fdf5f0;
    }
    .upload-zone input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .upload-zone .icon { font-size: 2rem; margin-bottom: 6px; }
    .upload-zone .label { font-size: 0.85rem; color: #888; line-height: 1.5; }
    .upload-zone .label strong { color: #5a4a42; }
    .upload-zone .current-file { font-size: 0.75rem; color: #bbb; margin-top: 6px; }

    /* â”€â”€ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ‘ãƒãƒ« â”€â”€ */
    .effect-panel {
      background: #fdfbf9;
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 16px 18px;
      margin-bottom: 12px;
      display: none;
    }
    .effect-panel.visible { display: block; }
    .effect-section {
      margin-bottom: 14px;
    }
    .effect-section:last-child { margin-bottom: 0; }
    .effect-section h4 {
      font-size: 0.7rem;
      font-weight: 500;
      color: #bbb;
      margin-bottom: 8px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    /* â”€â”€ ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ â”€â”€ */
    .color-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .color-row-label {
      font-size: 0.72rem;
      color: #999;
      width: 68px;
      flex-shrink: 0;
    }
    .palette {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }
    .swatch:hover { transform: scale(1.15); }
    .swatch.active {
      border-color: #5a4a42;
      box-shadow: 0 0 0 2px #fff, 0 0 0 4px #5a4a42;
    }

    /* â”€â”€ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ â”€â”€ */
    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    .slider-row:last-child { margin-bottom: 0; }
    .slider-label {
      font-size: 0.72rem;
      color: #999;
      width: 68px;
      flex-shrink: 0;
    }
    .slider-row input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 2px;
      background: #e6dfd8;
      outline: none;
    }
    .slider-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #5a4a42;
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    .slider-row input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #5a4a42;
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    .slider-value {
      font-size: 0.68rem;
      color: #bbb;
      width: 34px;
      text-align: right;
      flex-shrink: 0;
    }

    /* â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€ */
    .btn-row { display: flex; gap: 8px; }
    .btn {
      flex: 1;
      padding: 14px 12px;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary {
      background: linear-gradient(135deg, #d4728c, #b8a9c9);
      color: #fff;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #f0ebe6; color: #5a4a42; }
    .btn-secondary:hover { background: #e6dfd8; }

    /* â”€â”€ ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â”€â”€ */
    .batch-section {
      text-align: center;
      padding: 16px;
      border-top: 1px solid #eee;
      margin-top: 8px;
    }
    .btn-batch {
      display: inline-block;
      padding: 12px 32px;
      border: none;
      border-radius: 10px;
      background: #5a4a42;
      color: #fff;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-batch:hover { opacity: 0.85; }
    .btn-batch:disabled { opacity: 0.35; cursor: not-allowed; }
    .batch-note { font-size: 0.75rem; color: #bbb; margin-top: 8px; }

    /* â”€â”€ ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ â”€â”€ */
    .progress { text-align: center; padding: 12px; color: #999; font-size: 0.8rem; }
    .progress:empty { display: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>2026 Calendar Wallpaper</h1>
    <p>å†™çœŸã‚’é¸ã‚“ã§ã‚ªãƒªã‚¸ãƒŠãƒ«å£ç´™ã‚’ä½œã‚ã† - 1080 x 1920px</p>
  </div>

  <div class="month-nav" id="monthNav"></div>

  <div class="main">
    <div class="preview-card">
      <h3 id="monthTitle"></h3>
      <div class="canvas-wrap">
        <canvas id="canvas"></canvas>
      </div>
    </div>

    <div class="upload-zone" id="uploadZone">
      <div class="icon">ğŸ“·</div>
      <div class="label">
        <strong>å†™çœŸã‚’é¸æŠ</strong>ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>
        ã“ã®æœˆã®å£ç´™ã«ä½¿ã†å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„
      </div>
      <div class="current-file" id="currentFile"></div>
      <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="effect-panel" id="effectPanel">
      <!-- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ -->
      <div class="effect-section">
        <h4>ã‚«ãƒ©ãƒ¼è¨­å®š</h4>
        <div class="color-row">
          <span class="color-row-label">èƒŒæ™¯è‰²</span>
          <div class="palette" id="bgPalette"></div>
        </div>
        <div class="color-row">
          <span class="color-row-label">ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</span>
          <div class="palette" id="overlayPalette"></div>
        </div>
      </div>

      <!-- ã¼ã‹ã—ãƒ»é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
      <div class="effect-section">
        <h4>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</h4>
        <div class="slider-row">
          <span class="slider-label">ã¼ã‹ã—</span>
          <input type="range" id="blurSlider" min="0" max="10" step="0.5" value="3">
          <span class="slider-value" id="blurValue">3px</span>
        </div>
        <div class="slider-row">
          <span class="slider-label">é€æ˜åº¦</span>
          <input type="range" id="overlaySlider" min="0" max="70" step="1" value="30">
          <span class="slider-value" id="overlayValue">30%</span>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" id="downloadBtn" disabled>ã“ã®æœˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn btn-secondary" id="removeBtn" style="flex:0.5; display:none;">å†™çœŸã‚’å¤–ã™</button>
    </div>

    <div class="batch-section">
      <button class="btn-batch" id="downloadAllBtn" disabled>å†™çœŸã‚’è¨­å®šã—ãŸæœˆã‚’ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <div class="batch-note" id="batchNote">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æœ‰åŠ¹ã«ãªã‚Šã¾ã™</div>
    </div>

    <div class="progress" id="progress"></div>
  </div>

  <script>
(() => {
  const W = 1080;
  const H = 1920;

  const MONTH_EN = [
    'JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE',
    'JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'
  ];
  const MONTH_JP = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  const DAY_LABELS = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

  // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚«ãƒ©ãƒ¼
  const PRESET_COLORS = [
    { name: 'ãƒ”ãƒ³ã‚¯',       hex: '#FFF5F5' },
    { name: 'ãƒ™ãƒ¼ã‚¸ãƒ¥',     hex: '#F5F5DC' },
    { name: 'ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼',   hex: '#E6E6FA' },
    { name: 'ãƒŸãƒ³ãƒˆ',       hex: '#F0FFF0' },
    { name: 'ãƒ”ãƒ¼ãƒ',       hex: '#FFDAB9' },
    { name: 'ã‚¹ã‚«ã‚¤ãƒ–ãƒ«ãƒ¼', hex: '#F0F8FF' },
    { name: 'ã‚¢ã‚¤ãƒœãƒªãƒ¼',   hex: '#FFFFF0' },
  ];

  // æœˆãƒ†ãƒ¼ãƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
  const THEMES = [
    { top: '#FFF5F5', bottom: '#FFE4E1', accent: '#E8A0BF', badge: '#D4728C' },
    { top: '#F5F0FF', bottom: '#E8E0F0', accent: '#B8A9C9', badge: '#9B8BB4' },
    { top: '#FFF5F0', bottom: '#FFE8E0', accent: '#F0B8A0', badge: '#D4907A' },
    { top: '#F0FFF5', bottom: '#E0F5E8', accent: '#A0D4B8', badge: '#7AB89A' },
    { top: '#F5FFF0', bottom: '#E8F5E0', accent: '#B8D4A0', badge: '#96B87A' },
    { top: '#F0F5FF', bottom: '#E0E8F5', accent: '#A0B8D4', badge: '#7A96B8' },
    { top: '#F0FAFF', bottom: '#E0F0F8', accent: '#90C8E0', badge: '#6AAEC8' },
    { top: '#FFFAF0', bottom: '#F5EDE0', accent: '#D4C0A0', badge: '#B8A080' },
    { top: '#FFF8F0', bottom: '#F0E4D8', accent: '#D4A878', badge: '#B88A5C' },
    { top: '#F8F0F5', bottom: '#EAE0E8', accent: '#C4A0B8', badge: '#A87A96' },
    { top: '#FAF5F0', bottom: '#EDE8E0', accent: '#C8B8A0', badge: '#A89878' },
    { top: '#F0F8FA', bottom: '#E0EEF2', accent: '#A0C4D0', badge: '#7AA0B4' },
  ];

  const HOLIDAYS = new Set([
    '1-1','1-12','2-11','2-23','3-20','4-29',
    '5-3','5-4','5-5','5-6','7-20','8-11',
    '9-21','9-23','10-12','11-3','11-23'
  ]);
  function isHoliday(m, d) { return HOLIDAYS.has(`${m+1}-${d}`); }
  function getDowMon(month, day) {
    const d = new Date(2026, month, day).getDay();
    return d === 0 ? 6 : d - 1;
  }
  function getDaysInMonth(m) { return new Date(2026, m + 1, 0).getDate(); }

  // hex ã‚’ {r,g,b} ã«å¤‰æ›
  function hexToRgb(hex) {
    const n = parseInt(hex.replace('#', ''), 16);
    return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
  }
  // hex ã‚’å°‘ã—æš—ãã—ã¦ accent / badge ç”Ÿæˆ
  function darken(hex, amount) {
    const { r, g, b } = hexToRgb(hex);
    const f = 1 - amount;
    const to2 = (v) => Math.round(v * f).toString(16).padStart(2, '0');
    return '#' + to2(r) + to2(g) + to2(b);
  }

  // â”€â”€ æœˆåˆ¥è¨­å®š â”€â”€
  const DEFAULTS = { blur: 3, overlay: 30, bgColor: null, overlayColor: '#FFF5F5' };
  const photos = new Array(12).fill(null);
  const settings = Array.from({ length: 12 }, () => ({ ...DEFAULTS }));

  // localStorage å¾©å…ƒ
  const LS_KEY = 'calendarSettings2026';
  try {
    const saved = JSON.parse(localStorage.getItem(LS_KEY));
    if (saved) saved.forEach((s, i) => { if (s) Object.assign(settings[i], s); });
  } catch (_) {}
  function saveSettings() { localStorage.setItem(LS_KEY, JSON.stringify(settings)); }

  // â”€â”€ Canvas â”€â”€
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = W; canvas.height = H;
  const offCanvas = document.createElement('canvas');
  offCanvas.width = W; offCanvas.height = H;
  const offCtx = offCanvas.getContext('2d');

  // â”€â”€ DOM â”€â”€
  const monthNav = document.getElementById('monthNav');
  const monthTitle = document.getElementById('monthTitle');
  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const currentFile = document.getElementById('currentFile');
  const downloadBtn = document.getElementById('downloadBtn');
  const removeBtn = document.getElementById('removeBtn');
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  const batchNote = document.getElementById('batchNote');
  const progress = document.getElementById('progress');
  const effectPanel = document.getElementById('effectPanel');
  const blurSlider = document.getElementById('blurSlider');
  const blurValue = document.getElementById('blurValue');
  const overlaySlider = document.getElementById('overlaySlider');
  const overlayValue = document.getElementById('overlayValue');
  const bgPalette = document.getElementById('bgPalette');
  const overlayPalette = document.getElementById('overlayPalette');

  let currentMonth = 0;

  // â”€â”€ ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆ â”€â”€
  function buildPalette(container, type) {
    // ã€Œè‡ªå‹•ã€ã‚¹ã‚¦ã‚©ãƒƒãƒ
    const autoSw = document.createElement('div');
    autoSw.className = 'swatch';
    autoSw.dataset.color = '';
    autoSw.dataset.type = type;
    autoSw.title = 'è‡ªå‹•ï¼ˆæœˆãƒ†ãƒ¼ãƒï¼‰';
    autoSw.style.background = 'conic-gradient(#FFF5F5, #E6E6FA, #F0FFF0, #FFDAB9, #F0F8FF, #FFF5F5)';
    autoSw.addEventListener('click', () => pickColor(type, null));
    container.appendChild(autoSw);

    PRESET_COLORS.forEach(pc => {
      const sw = document.createElement('div');
      sw.className = 'swatch';
      sw.dataset.color = pc.hex;
      sw.dataset.type = type;
      sw.title = pc.name;
      sw.style.background = pc.hex;
      sw.style.boxShadow = `inset 0 0 0 1px rgba(0,0,0,0.08)`;
      sw.addEventListener('click', () => pickColor(type, pc.hex));
      container.appendChild(sw);
    });
  }
  buildPalette(bgPalette, 'bg');
  buildPalette(overlayPalette, 'overlay');

  function pickColor(type, hex) {
    if (type === 'bg') settings[currentMonth].bgColor = hex;
    else settings[currentMonth].overlayColor = hex || '#FFF5F5';
    saveSettings();
    updateSwatches();
    render();
  }

  function updateSwatches() {
    const s = settings[currentMonth];
    bgPalette.querySelectorAll('.swatch').forEach(sw => {
      const c = sw.dataset.color || null;
      sw.classList.toggle('active', c === s.bgColor);
    });
    overlayPalette.querySelectorAll('.swatch').forEach(sw => {
      const c = sw.dataset.color || null;
      const current = s.overlayColor || null;
      // auto = null matches first swatch (empty string)
      if (!c && !current) sw.classList.add('active');
      else sw.classList.toggle('active', c === current);
    });
  }

  // â”€â”€ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ â”€â”€
  blurSlider.addEventListener('input', () => {
    settings[currentMonth].blur = parseFloat(blurSlider.value);
    blurValue.textContent = blurSlider.value + 'px';
    saveSettings(); render();
  });
  overlaySlider.addEventListener('input', () => {
    settings[currentMonth].overlay = parseInt(overlaySlider.value);
    overlayValue.textContent = overlaySlider.value + '%';
    saveSettings(); render();
  });

  // â”€â”€ æœˆãƒŠãƒ“ â”€â”€
  for (let i = 0; i < 12; i++) {
    const btn = document.createElement('button');
    btn.innerHTML = `${i+1}æœˆ<span class="dot" data-dot="${i}"></span>`;
    btn.dataset.month = i;
    if (i === 0) btn.classList.add('active');
    btn.addEventListener('click', () => selectMonth(i));
    monthNav.appendChild(btn);
  }

  function selectMonth(i) {
    currentMonth = i;
    monthNav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    monthNav.children[i].classList.add('active');
    updateUI(); render();
  }

  // â”€â”€ å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â”€â”€
  fileInput.addEventListener('change', (e) => { if (e.target.files[0]) loadPhoto(e.target.files[0]); });
  uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
  uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault(); uploadZone.classList.remove('dragover');
    if (e.dataTransfer.files[0]) loadPhoto(e.dataTransfer.files[0]);
  });

  function loadPhoto(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        photos[currentMonth] = img;
        currentFile.textContent = file.name;
        updateUI(); render();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  removeBtn.addEventListener('click', () => {
    photos[currentMonth] = null;
    settings[currentMonth] = { ...DEFAULTS };
    saveSettings();
    fileInput.value = '';
    currentFile.textContent = '';
    updateUI(); render();
  });

  // â”€â”€ UIæ›´æ–° â”€â”€
  function updateUI() {
    const hasPhoto = !!photos[currentMonth];
    const s = settings[currentMonth];
    monthTitle.textContent = `${MONTH_JP[currentMonth]} / ${MONTH_EN[currentMonth]} 2026`;
    downloadBtn.disabled = !hasPhoto;
    removeBtn.style.display = hasPhoto ? '' : 'none';
    currentFile.textContent = hasPhoto ? (currentFile.textContent || 'å†™çœŸè¨­å®šæ¸ˆã¿') : '';

    effectPanel.classList.toggle('visible', hasPhoto);
    if (hasPhoto) {
      blurSlider.value = s.blur;
      blurValue.textContent = s.blur + 'px';
      overlaySlider.value = s.overlay;
      overlayValue.textContent = s.overlay + '%';
      updateSwatches();
    }

    for (let i = 0; i < 12; i++) {
      document.querySelector(`[data-dot="${i}"]`).classList.toggle('visible', !!photos[i]);
    }
    const count = photos.filter(Boolean).length;
    downloadAllBtn.disabled = count === 0;
    batchNote.textContent = count > 0
      ? `${count}ãƒ¶æœˆåˆ†ã®å†™çœŸãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™`
      : 'å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æœ‰åŠ¹ã«ãªã‚Šã¾ã™';
  }

  // â”€â”€ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â”€â”€
  downloadBtn.addEventListener('click', () => {
    if (!photos[currentMonth]) return;
    downloadCanvas(canvas, currentMonth);
  });
  downloadAllBtn.addEventListener('click', async () => {
    const cvs = document.createElement('canvas'); cvs.width = W; cvs.height = H;
    const tmpCtx = cvs.getContext('2d');
    let downloaded = 0;
    for (let i = 0; i < 12; i++) {
      if (!photos[i]) continue;
      downloaded++;
      progress.textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­... (${downloaded}/${photos.filter(Boolean).length})`;
      renderToContext(tmpCtx, i);
      downloadCanvas(cvs, i);
      await new Promise(r => setTimeout(r, 500));
    }
    progress.textContent = `${downloaded}ãƒ¶æœˆåˆ†ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼`;
    setTimeout(() => { progress.textContent = ''; }, 3000);
  });
  function downloadCanvas(cvs, mi) {
    const link = document.createElement('a');
    link.download = `calendar_2026_${String(mi+1).padStart(2,'0')}.png`;
    link.href = cvs.toDataURL('image/png');
    link.click();
  }

  // â”€â”€ æç”» â”€â”€
  function render() { renderToContext(ctx, currentMonth); }

  function getThemeForMonth(mi) {
    const s = settings[mi];
    const base = THEMES[mi];
    if (!s.bgColor) return base;
    // ã‚«ã‚¹ã‚¿ãƒ èƒŒæ™¯è‰²ã‹ã‚‰ãƒ†ãƒ¼ãƒç”Ÿæˆ
    return {
      top: s.bgColor,
      bottom: darken(s.bgColor, 0.06),
      accent: darken(s.bgColor, 0.25),
      badge: darken(s.bgColor, 0.4),
    };
  }

  function renderToContext(c, mi) {
    const theme = getThemeForMonth(mi);
    const days = getDaysInMonth(mi);
    const photo = photos[mi];
    const s = settings[mi];

    // èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const bgGrad = c.createLinearGradient(0, 0, 0, H);
    bgGrad.addColorStop(0, theme.top);
    bgGrad.addColorStop(1, theme.bottom);
    c.fillStyle = bgGrad;
    c.fillRect(0, 0, W, H);

    // è£…é£¾å††
    c.fillStyle = theme.accent + '18';
    c.beginPath(); c.arc(W - 80, 120, 260, 0, Math.PI * 2); c.fill();
    c.fillStyle = theme.accent + '12';
    c.beginPath(); c.arc(100, H - 200, 180, 0, Math.PI * 2); c.fill();

    // â”€â”€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ â”€â”€
    const calTop = 60;
    const badgeR = 52;
    const badgeX = 80 + badgeR;
    const badgeY = calTop + 50;
    c.fillStyle = theme.badge;
    c.beginPath(); c.arc(badgeX, badgeY, badgeR, 0, Math.PI * 2); c.fill();
    c.fillStyle = '#fff';
    c.font = '700 38px "Noto Sans JP", sans-serif';
    c.textAlign = 'center'; c.textBaseline = 'middle';
    c.fillText(String(mi + 1), badgeX, badgeY - 6);
    c.font = '400 16px "Noto Sans JP", sans-serif';
    c.fillText('æœˆ', badgeX, badgeY + 22);

    c.fillStyle = '#4a4a4a';
    c.font = '700 28px "Noto Sans JP", sans-serif';
    c.textAlign = 'left';
    c.fillText(MONTH_EN[mi], badgeX + badgeR + 20, badgeY - 10);
    c.fillStyle = '#999';
    c.font = '300 20px "Noto Sans JP", sans-serif';
    c.fillText('2026', badgeX + badgeR + 20, badgeY + 18);

    // â”€â”€ 2æ®µã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ â”€â”€
    const gridTop = calTop + 115;
    const gridPadX = 48;
    const gridW = W - gridPadX * 2;
    const halfW = gridW / 2 - 12;
    const colW = halfW / 7;
    const rowH = 38;
    const headerH = 28;
    const colorWeekday = '#333333';
    const colorSat = '#4A90E2';
    const colorSun = '#E94B3C';
    const colorHeader = '#aaaaaa';

    for (let half = 0; half < 2; half++) {
      const offsetX = gridPadX + half * (halfW + 24);
      const startDay = half === 0 ? 1 : 16;
      const endDay = half === 0 ? 15 : days;

      if (half === 1) {
        c.strokeStyle = theme.accent + '40';
        c.lineWidth = 1; c.beginPath();
        const lineEnd = gridTop + headerH + Math.ceil((endDay - startDay + 1 + getDowMon(mi, startDay)) / 7) * rowH + 4;
        c.moveTo(offsetX - 12, gridTop - 4);
        c.lineTo(offsetX - 12, lineEnd); c.stroke();
      }
      c.font = '500 16px "Noto Sans JP", sans-serif';
      c.textAlign = 'center'; c.textBaseline = 'middle';
      for (let i = 0; i < 7; i++) {
        const x = offsetX + i * colW + colW / 2;
        c.fillStyle = i === 5 ? colorSat : i === 6 ? colorSun : colorHeader;
        c.fillText(DAY_LABELS[i], x, gridTop + headerH / 2);
      }
      c.font = '400 20px "Noto Sans JP", sans-serif';
      let col = getDowMon(mi, startDay);
      let row = 0;
      for (let d = startDay; d <= endDay; d++) {
        const x = offsetX + col * colW + colW / 2;
        const y = gridTop + headerH + row * rowH + rowH / 2;
        const dow = getDowMon(mi, d);
        c.fillStyle = (dow === 6 || isHoliday(mi, d)) ? colorSun : dow === 5 ? colorSat : colorWeekday;
        c.fillText(String(d), x, y);
        col++;
        if (col >= 7) { col = 0; row++; }
      }
    }

    // â”€â”€ å†™çœŸã‚¨ãƒªã‚¢ â”€â”€
    const photoTop = H * 0.24;
    const photoMargin = 48;
    const photoW = W - photoMargin * 2;
    const photoH = H - photoTop - photoMargin;
    const photoR = 24;

    if (photo) {
      const blurPx = s.blur;
      const overlayAlpha = s.overlay / 100;
      const olColor = hexToRgb(s.overlayColor || '#FFF5F5');

      // Cover fit
      const imgRatio = photo.width / photo.height;
      const areaRatio = photoW / photoH;
      let sx, sy, sw, sh;
      if (imgRatio > areaRatio) {
        sh = photo.height; sw = sh * areaRatio;
        sx = (photo.width - sw) / 2; sy = 0;
      } else {
        sw = photo.width; sh = sw / areaRatio;
        sx = 0; sy = (photo.height - sh) / 2;
      }

      if (blurPx > 0) {
        offCtx.clearRect(0, 0, W, H);
        offCtx.filter = `blur(${blurPx}px)`;
        offCtx.drawImage(photo, sx, sy, sw, sh, photoMargin, photoTop, photoW, photoH);
        offCtx.filter = 'none';
        c.save();
        roundRect(c, photoMargin, photoTop, photoW, photoH, photoR); c.clip();
        c.drawImage(offCanvas, 0, 0);
        c.restore();
      } else {
        c.save();
        roundRect(c, photoMargin, photoTop, photoW, photoH, photoR); c.clip();
        c.drawImage(photo, sx, sy, sw, sh, photoMargin, photoTop, photoW, photoH);
        c.restore();
      }

      // ã‚«ãƒ©ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
      if (overlayAlpha > 0) {
        c.save();
        roundRect(c, photoMargin, photoTop, photoW, photoH, photoR); c.clip();
        c.fillStyle = `rgba(${olColor.r}, ${olColor.g}, ${olColor.b}, ${overlayAlpha})`;
        c.fillRect(photoMargin, photoTop, photoW, photoH);
        c.restore();
      }

      // è§’ä¸¸ãƒœãƒ¼ãƒ€ãƒ¼
      c.strokeStyle = 'rgba(255,255,255,0.5)';
      c.lineWidth = 3;
      roundRect(c, photoMargin, photoTop, photoW, photoH, photoR); c.stroke();
    } else {
      c.fillStyle = theme.accent + '12';
      roundRect(c, photoMargin, photoTop, photoW, photoH, photoR); c.fill();
      c.strokeStyle = theme.accent + '40';
      c.lineWidth = 2; c.setLineDash([10, 8]);
      roundRect(c, photoMargin + 10, photoTop + 10, photoW - 20, photoH - 20, photoR - 4); c.stroke();
      c.setLineDash([]);
      const cx = W / 2;
      const cy = photoTop + photoH / 2;
      c.fillStyle = theme.accent + '20';
      c.beginPath(); c.arc(cx, cy - 30, 48, 0, Math.PI * 2); c.fill();
      c.strokeStyle = theme.accent + '50';
      c.lineWidth = 2.5;
      c.beginPath(); c.arc(cx, cy - 30, 24, 0, Math.PI * 2); c.stroke();
      c.fillStyle = theme.accent + '70';
      c.font = '500 26px "Noto Sans JP", sans-serif';
      c.textAlign = 'center'; c.textBaseline = 'middle';
      c.fillText('YOUR PHOTO HERE', cx, cy + 40);
      c.fillStyle = theme.accent + '45';
      c.font = '300 18px "Noto Sans JP", sans-serif';
      c.fillText('å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„', cx, cy + 72);
    }
  }

  function roundRect(c, x, y, w, h, r) {
    c.beginPath();
    c.moveTo(x + r, y);
    c.lineTo(x + w - r, y);
    c.quadraticCurveTo(x + w, y, x + w, y + r);
    c.lineTo(x + w, y + h - r);
    c.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    c.lineTo(x + r, y + h);
    c.quadraticCurveTo(x, y + h, x, y + h - r);
    c.lineTo(x, y + r);
    c.quadraticCurveTo(x, y, x + r, y);
    c.closePath();
  }

  updateUI();
  render();
})();
  </script>
</body>
</html>
